# 管理员权限自动提升 - 完整实现说明

## ✅ 已完成的修改

### 1. WPF 应用程序自动申请管理员权限

#### 创建的文件
**文件**: `MoveWithSymlinkWPF/app.manifest`

这是一个 Windows 应用程序清单文件，包含以下关键配置：

```xml
<requestedExecutionLevel level="requireAdministrator" uiAccess="false" />
```

**作用**：
- 应用程序启动时自动触发 UAC（用户账户控制）对话框
- 只有用户点击"是"授予管理员权限后，应用程序才会启动
- 如果用户拒绝，应用程序不会启动

#### 修改的文件
**文件**: `MoveWithSymlinkWPF/MoveWithSymlinkWPF.csproj`

添加了 manifest 引用：
```xml
<ApplicationManifest>app.manifest</ApplicationManifest>
```

### 2. 启动脚本自动申请管理员权限

**文件**: `run.ps1`

简化的启动脚本，直接使用 `-Verb RunAs` 启动应用程序：

```powershell
Start-Process -FilePath $exePath -Verb RunAs
```

**特点**：
- 脚本本身无需管理员权限
- 通过 `-Verb RunAs` 参数启动 exe，触发 UAC

---

## 🎯 使用方式对比

### 方式 1：直接双击 exe（推荐用于分发）
```
双击 目录迁移工具.exe
→ 自动弹出 UAC 对话框
→ 点击"是"
→ 应用以管理员身份启动
```

**优势**：
- ✅ 一步到位，最简单
- ✅ 用户体验最好
- ✅ 适合分发给其他用户

### 方式 2：使用 run.ps1 脚本
```
双击或右键运行 run.ps1
→ 自动弹出 UAC 对话框
→ 点击"是"
→ 应用以管理员身份启动
```

**优势**：
- ✅ 显示友好提示信息
- ✅ 错误处理更完善
- ✅ 可以添加额外的启动前检查

---

## 🔄 重新发布应用程序

**重要**：manifest 文件只有在重新发布后才会生效！

### 使用发布脚本（推荐）
```powershell
.\publish.ps1
```

### 手动发布
```powershell
dotnet publish MoveWithSymlinkWPF\MoveWithSymlinkWPF.csproj `
  -p:PublishProfile=win-x64 `
  -c Release
```

### 发布后的文件位置
```
MoveWithSymlinkWPF\bin\publish\win-x64\目录迁移工具.exe
```

---

## 🧪 验证方法

### 1. 检查 exe 文件属性
1. 右键点击 `目录迁移工具.exe`
2. 选择"属性"
3. 切换到"详细信息"选项卡
4. 查看"公司"应显示"诏无言"
5. 切换到"兼容性"选项卡
6. 应该看到底部有"以管理员身份运行此程序"的提示

### 2. 实际运行测试
1. 以普通用户身份双击 exe
2. 应该立即弹出 UAC 对话框（不是应用程序窗口）
3. UAC 对话框标题应该是"您要允许此应用对您的设备进行更改吗？"
4. 点击"是"后，应用程序才会打开

### 3. 在应用内验证
启动应用后：
1. 选择源路径和目标路径
2. 点击"开始验证"
3. 应该不再显示"当前非管理员权限"的警告
4. 权限检查应该通过

---

## 📋 技术细节

### Manifest 文件说明

#### requestedExecutionLevel 的三个级别

1. **asInvoker**（默认）
   - 以启动应用程序的用户相同的权限级别运行
   - 不会触发 UAC

2. **highestAvailable**
   - 使用当前用户可用的最高权限级别
   - 管理员账户会触发 UAC
   - 普通用户不会触发 UAC，以普通权限运行

3. **requireAdministrator**（我们使用的）
   - 必须以管理员权限运行
   - 始终触发 UAC
   - 用户拒绝则应用不启动

#### 为什么选择 requireAdministrator？

创建符号链接在 Windows 上**必须**有管理员权限（除非启用开发者模式），所以：
- ✅ 确保应用一定有足够权限
- ✅ 避免用户在操作中途遇到权限错误
- ✅ 提供最一致的用户体验

### DPI 感知设置

Manifest 中还包含 DPI 感知设置：
```xml
<dpiAware>true</dpiAware>
<dpiAwareness>PerMonitorV2</dpiAwareness>
```

**作用**：
- 应用程序在高 DPI 显示器上正确缩放
- 支持多显示器不同 DPI 设置
- 避免界面模糊

### 兼容性声明

```xml
<supportedOS Id="{8e0f7a12-bfb3-4fe8-b9a5-48fd50a15a9a}" />
```

声明应用支持 Windows 10 和 Windows 11。

---

## 🔍 故障排除

### 问题：双击 exe 没有弹出 UAC

**可能原因**：
1. 还没有重新发布应用程序
2. 运行的是旧版本的 exe
3. 已经以管理员身份登录（不会再次弹出 UAC）

**解决方法**：
```powershell
# 1. 重新发布
.\publish.ps1

# 2. 检查文件日期
Get-Item "MoveWithSymlinkWPF\bin\publish\win-x64\目录迁移工具.exe" | Select-Object LastWriteTime

# 3. 检查当前用户权限
[Security.Principal.WindowsIdentity]::GetCurrent().Groups -contains 'S-1-5-32-544'
```

### 问题：UAC 弹出但应用没有启动

**可能原因**：
- 用户点击了"否"拒绝授权

**解决方法**：
- 再次运行，点击"是"授权

### 问题：想要让应用不需要管理员权限

**修改方法**：

1. 编辑 `MoveWithSymlinkWPF/app.manifest`
2. 将 `requireAdministrator` 改为 `asInvoker`：
   ```xml
   <requestedExecutionLevel level="asInvoker" uiAccess="false" />
   ```
3. 重新发布

**注意**：这样会导致创建符号链接失败，除非启用了开发者模式。

---

## 📊 对比：修改前后

| 场景 | 修改前 | 修改后 |
|-----|-------|-------|
| 双击 exe | 以普通权限启动 → 创建链接失败 | 弹出 UAC → 以管理员身份启动 ✅ |
| 使用 run.ps1 | 需要脚本自己处理提权 | exe 自动提权，脚本只负责启动 ✅ |
| 分发给用户 | 需要教育用户"右键→管理员运行" | 用户双击即可，自动弹 UAC ✅ |
| 开发者体验 | 每次测试都要手动提权 | 直接运行，自动提权 ✅ |

---

## ✅ 验证清单

发布后请验证以下项目：

- [ ] 双击 exe 会弹出 UAC 对话框
- [ ] UAC 对话框显示正确的应用程序名称
- [ ] 点击"是"后应用以管理员身份启动
- [ ] 应用内权限检查通过（无警告）
- [ ] 可以成功创建符号链接
- [ ] run.ps1 脚本正常工作
- [ ] exe 文件可以独立运行（不依赖脚本）

---

## 🎊 总结

### 实现的功能
✅ WPF 应用程序内嵌 manifest，启动时自动申请管理员权限  
✅ 用户只需双击 exe，无需额外操作  
✅ 提供了 run.ps1 作为备选启动方式  
✅ 完善的错误处理和用户提示  

### 用户体验
- **最佳**：双击 exe → UAC 授权 → 开始使用
- **备选**：运行 run.ps1 → UAC 授权 → 开始使用
- **不推荐**：右键 → 以管理员身份运行（仍然可用）

### 技术优势
- ✅ 符合 Windows 应用程序标准做法
- ✅ 充分利用操作系统的 UAC 机制
- ✅ 无需额外的启动器或包装脚本
- ✅ 适合作为独立应用分发

---

**开发日期**: 2025-10-22  
**版本**: 1.1.0  
**关键改进**: 内嵌管理员权限清单，实现真正的一键启动

