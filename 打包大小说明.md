# 打包大小说明文档

## 问题
为什么有时候打包 40 多 MB，有时候 70 多 MB？

## 答案

### 当前实际情况
经过测试，使用相同配置打包的 EXE 文件大小是 **74.47 MB**。

### 大小差异的主要原因

#### 1. **调试符号 (Debug Symbols) - 影响不大**
- **.pdb 文件**: 包含调试符号，单独只有约 0.05 MB
- **嵌入的调试信息**: 如果 EXE 中包含调试信息，可能增加 1-2 MB
- **解决方案**: 
  ```xml
  <DebugType>None</DebugType>
  <DebugSymbols>false</DebugSymbols>
  <CopyOutputSymbolsToPublishDirectory>false</CopyOutputSymbolsToPublishDirectory>
  ```

#### 2. **ReadyToRun (R2R) 预编译 - 影响最大**
- **禁用时 (PublishReadyToRun=false)**: 约 70-75 MB
- **启用时 (PublishReadyToRun=true)**: 约 90-100 MB
- **差异**: 增加约 **20-30 MB** (30-40%)
- **优势**: 启动速度更快，运行时性能略好
- **劣势**: 文件体积明显增加

#### 3. **代码裁剪 (Trimming) - WPF 不适用**
- **理论上**: 可以减少到 40-50 MB
- **实际情况**: WPF 应用大量使用反射，裁剪会导致运行时错误
- **结论**: **不推荐在 WPF 应用中使用**

#### 4. **发布模式**
- **Debug 模式**: 约 80-90 MB（包含完整调试信息）
- **Release 模式**: 约 70-75 MB（移除调试信息）
- **差异**: 约 10-15 MB

### 文件大小对比表

| 配置方案 | 文件大小 | ReadyToRun | Trimming | Debug Symbols | 备注 |
|---------|---------|-----------|----------|---------------|------|
| **标准版（推荐）** | **~74 MB** | ❌ 禁用 | ❌ 禁用 | ❌ 无 | 平衡体积和功能 |
| 调试版 | ~76 MB | ❌ 禁用 | ❌ 禁用 | ✅ 有 | 包含 PDB 文件 |
| 快速启动版 | ~95 MB | ✅ 启用 | ❌ 禁用 | ❌ 无 | 启动更快 |
| 小体积版 | ~40 MB | ❌ 禁用 | ✅ 启用 | ❌ 无 | ⚠️ WPF 不兼容 |

### 为什么是 74 MB 而不是更小？

.NET 8 单文件发布包含：
1. **完整的 .NET 运行时** (~50 MB)
   - CoreCLR 虚拟机
   - 基础类库 (BCL)
   - JIT 编译器

2. **WPF 框架** (~15 MB)
   - PresentationCore
   - PresentationFramework
   - WindowsBase
   - 本地互操作库

3. **应用程序代码** (~5 MB)
   - MoveWithSymlinkWPF.dll
   - MigrationCore.dll
   - CommunityToolkit.Mvvm.dll

4. **其他依赖和元数据** (~4 MB)

### 如何使用不同的打包配置

#### 方法 1: 使用原始脚本（标准版）
```powershell
.\publish.ps1
```
- 大小: ~74 MB
- 最常用，推荐

#### 方法 2: 使用高级脚本
```powershell
# 标准版（推荐）
.\publish-advanced.ps1 standard

# 快速启动版（体积更大，启动更快）
.\publish-advanced.ps1 fast

# 所有版本
.\publish-advanced.ps1 all
```

### 配置文件位置

- 标准版: `MoveWithSymlinkWPF/Properties/PublishProfiles/win-x64.pubxml`
- 快速版: `MoveWithSymlinkWPF/Properties/PublishProfiles/win-x64-fast.pubxml`

### 结论

1. **正常情况下**: 打包大小应该稳定在 **74-76 MB**
2. **如果是 40 MB**: 可能是使用了不完整的配置或者是其他版本的应用
3. **如果是 90+ MB**: 可能启用了 ReadyToRun 预编译
4. **推荐配置**: 使用标准版（74 MB），平衡了体积和性能

### 优化建议

如果确实需要减小体积，可以考虑：
1. ✅ **移除调试符号** - 已实现（减少 1-2 MB）
2. ❌ **启用 Trimming** - 不推荐（WPF 不兼容）
3. ❌ **使用 .NET 依赖安装** - 需要用户预装 .NET 运行时
4. ✅ **保持 Release 模式发布** - 已实现

## 技术细节

### 查看当前 EXE 大小
```powershell
Get-Item "MoveWithSymlinkWPF\bin\publish\win-x64\目录迁移工具.exe" | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB, 2)}}
```

### 查看发布目录内容
```powershell
Get-ChildItem "MoveWithSymlinkWPF\bin\publish\win-x64\" -Force | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB, 2)}}
```

## 作者
诏无言

## 更新日期
2025-10-22

