# 管理员权限自动提升说明

## 功能概述

本项目的两个版本都支持**自动申请管理员权限**：

1. **PowerShell 脚本版本** (`MoveWithSymlink.ps1`)：脚本会自动检测权限并请求提升
2. **WPF 图形界面版本** (`run.ps1`)：启动脚本会以管理员身份启动应用程序

无需手动"右键→以管理员身份运行"。

## 工作原理

### 1. 启动检测
脚本在启动时会立即检测当前是否具有管理员权限：
```powershell
function Test-Administrator {
    $currentIdentity = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentIdentity)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}
```

### 2. 自动提升
如果检测到没有管理员权限，脚本会：
- 显示提示信息：`检测到当前不是管理员权限，正在请求提升权限...`
- 保留所有原始参数（Source、Target、LargeFileThresholdMB 等）
- 使用 `Start-Process` 配合 `-Verb RunAs` 重新启动脚本
- 弹出 UAC 对话框请求用户授权

### 3. 权限确认
成功获得管理员权限后，会显示确认信息：
```
✓ 已获得管理员权限
```

## 使用示例

### 基本用法（无需手动提升权限）
```powershell
# 直接运行，脚本会自动请求管理员权限
.\MoveWithSymlink.ps1 -Source "C:\Users\User\Desktop\OldFolder" -Target "D:\NewFolder"
```

### 带参数运行
```powershell
# 所有参数都会被正确传递到提升权限后的脚本
.\MoveWithSymlink.ps1 -Source "C:\Data" -Target "E:\Backup\Data" -LargeFileThresholdMB 2048 -RobocopyThreads 16
```

## 优势

1. **用户体验更好**：无需记住"右键→以管理员身份运行"
2. **防止错误**：避免用户忘记提升权限导致符号链接创建失败
3. **参数保留**：所有命令行参数在权限提升后完整保留
4. **错误处理**：如果用户拒绝 UAC 提示或提升失败，会有友好的错误提示

## 技术细节

### 参数传递机制
脚本使用 `$PSBoundParameters` 来检测哪些参数被实际传递：
```powershell
if ($PSBoundParameters.ContainsKey('Source')) {
    $argList += '-Source'
    $argList += "`"$Source`""
}
```

这确保了：
- 只传递用户实际指定的参数
- 参数值被正确引号包裹（处理包含空格的路径）
- 默认值不会被错误地显式传递

### 错误处理
如果权限提升失败（例如用户点击"否"），脚本会：
1. 显示错误信息
2. 等待用户按键确认
3. 返回退出码 1

### PowerShell 窗口保持
使用 `-NoExit` 参数确保脚本执行完成后窗口不会立即关闭，方便查看结果。

## 注意事项

1. **UAC 提示**：第一次运行时会看到 Windows UAC 对话框，这是正常现象
2. **信任来源**：只在信任的脚本上使用此功能
3. **开发者模式**：如果已启用 Windows 开发者模式，理论上不需要管理员权限即可创建符号链接，但脚本仍会请求提升以确保兼容性

## 相关修改

- **移除了原有的警告提示**：之前脚本会在中途检测权限并显示警告，现在由于启动时已确保权限，该检查已被移除
- **代码组织**：权限提升逻辑被组织在 `#region 自动申请管理员权限` 区域中，便于维护

## WPF 版本的权限管理

### 启动方式
使用 `run.ps1` 脚本启动 WPF 应用程序时，脚本会自动使用 `-Verb RunAs` 参数：

```powershell
# run.ps1 的关键代码
Start-Process -FilePath $exePath -Verb RunAs
```

### 用户体验
1. 运行 `.\run.ps1` 或双击 `run.ps1`
2. 会弹出一次 UAC 对话框
3. 点击"是"后，WPF 应用以管理员身份启动
4. 应用内的所有操作都具有管理员权限

### 权限验证
WPF 应用在"路径验证"步骤会检测当前权限状态：
- 如果有管理员权限：正常继续
- 如果没有管理员权限：会显示警告信息

## 版本历史

- **2025-10-22**：添加自动管理员权限申请功能
- **2025-10-22**：修复 WPF 版本管理员权限问题，确保 UAC 正确弹出

