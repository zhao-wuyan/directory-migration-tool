# 复制进度显示修复说明

## 问题描述
GUI版本在复制文件时显示的问题：
- 进度条显示100%
- 已复制大小显示为 0
- 复制速度显示为 0

## 根本原因
1. `ReportPhase` 方法在进入复制阶段时，会先报告一个基于阶段计算的进度（约33%），这会覆盖实际的复制进度
2. 复制开始时没有立即报告初始进度（0%），导致UI显示不正确
3. 复制完成后没有明确报告100%进度

## 修复方案

### 1. 修改 `ReportPhase` 方法
在 `MigrationCore\Services\MigrationService.cs` 中：

```csharp
private void ReportPhase(IProgress<MigrationProgress>? progress, IProgress<string>? logProgress, int phase, string description)
{
    logProgress?.Report($"[{phase}/6] {description}");

    // 只在非复制阶段报告基于阶段的进度，复制阶段由 CopyFilesAsync 自己报告
    if (phase != 3)
    {
        progress?.Report(new MigrationProgress
        {
            CurrentPhase = phase,
            PhaseDescription = description,
            PercentComplete = (phase - 1) * 100.0 / 6,
            Message = description
        });
    }
}
```

**修改原因**：阶段3是复制阶段，应该由 `CopyFilesAsync` 方法自己报告实际的复制进度，而不是报告一个估算的阶段进度。

### 2. 在复制开始时报告初始进度
在 `CopyFilesAsync` 方法开始时添加：

```csharp
// 报告初始进度
progress?.Report(new MigrationProgress
{
    CurrentPhase = 3,
    PhaseDescription = "复制文件",
    PercentComplete = 0,
    CopiedBytes = 0,
    TotalBytes = stats.TotalBytes,
    SpeedBytesPerSecond = 0,
    Message = $"准备复制 {FileStatsService.FormatBytes(stats.TotalBytes)}..."
});
```

**修改原因**：确保UI从0%开始显示进度，避免显示错误的初始值。

### 3. 在复制完成后报告最终进度
在 `CopyFilesAsync` 方法的验证完成后添加：

```csharp
// 报告最终100%进度
progress?.Report(new MigrationProgress
{
    CurrentPhase = 3,
    PhaseDescription = "复制文件",
    PercentComplete = 100,
    CopiedBytes = finalSize,
    TotalBytes = stats.TotalBytes,
    SpeedBytesPerSecond = 0,
    Message = $"复制完成: {FileStatsService.FormatBytes(finalSize)}"
});
```

**修改原因**：明确告知UI复制已完成，显示最终的文件大小。

## 进度更新流程

修复后的进度更新流程：

1. **阶段1-2**：路径验证、扫描源目录 - 使用阶段进度（0%, 16%）
2. **阶段3**：复制文件
   - 0%：开始复制
   - 1%-99%：实时更新（每秒一次）
     - 显示已复制/总大小
     - 显示实时速度
     - 显示预计剩余时间(ETA)
   - 100%：复制完成
3. **阶段4-6**：创建符号链接、健康检查、清理备份 - 使用阶段进度

## 测试验证

### WPF版本
- ✅ 已编译成功
- 运行命令：`.\运行WPF版本.ps1` 或直接运行可执行文件

### WinUI版本
- 需要使用 x64 平台编译：
  ```powershell
  dotnet build MoveWithSymlinkGUI\MoveWithSymlinkGUI.csproj -c Release /p:Platform=x64
  ```
- 或使用构建脚本：`.\build.ps1`

### 测试要点
1. 启动GUI应用
2. 选择源目录和目标目录
3. 点击扫描，确认扫描进度正常
4. 开始迁移，观察复制阶段：
   - ✅ 进度条从0%开始
   - ✅ 实时显示已复制大小
   - ✅ 实时显示复制速度
   - ✅ 显示预计剩余时间
   - ✅ 进度条平滑增长到100%

## 相关文件

- `MigrationCore\Services\MigrationService.cs` - 核心修复文件
- `MigrationCore\Models\MigrationProgress.cs` - 进度信息模型
- `MoveWithSymlinkGUI\ViewModels\MainViewModel.cs` - WinUI界面逻辑
- `MoveWithSymlinkWPF\ViewModels\MainViewModel.cs` - WPF界面逻辑

## 注意事项

1. 进度更新频率由 `SampleMilliseconds` 参数控制（默认1000ms）
2. 复制速度是实时计算的，可能会有波动
3. 对于小文件或快速复制，可能看不到中间进度（直接跳到100%）
4. 大文件复制时，进度更新更加明显和流畅

## 编译说明

### 编译所有项目
```powershell
.\build.ps1
```

### 单独编译各项目
```powershell
# 核心库
dotnet build MigrationCore\MigrationCore.csproj -c Release

# WPF版本
dotnet build MoveWithSymlinkWPF\MoveWithSymlinkWPF.csproj -c Release

# WinUI版本（需要指定平台）
dotnet build MoveWithSymlinkGUI\MoveWithSymlinkGUI.csproj -c Release /p:Platform=x64
```

## 发布说明

### 发布 WPF 版本
```powershell
.\publish-wpf.ps1
```
生成位置：`MoveWithSymlinkWPF\bin\publish\win-x64\`

### 发布 WinUI 版本
```powershell
.\publish.ps1
```
生成位置：`MoveWithSymlinkGUI\bin\publish\win-x64\`

---

修复日期：2025-10-22
修复人：AI Assistant

