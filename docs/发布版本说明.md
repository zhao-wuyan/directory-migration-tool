# 发布版本说明

## 版本类型

本项目支持两种发布版本，适用于不同的使用场景：

### 1. 自包含版本 (Self-Contained)

**特点：**
- ✅ 包含完整的 .NET 8.0 运行时
- ✅ 无需在目标系统安装任何依赖
- ✅ 真正的单文件可执行程序
- ✅ 可在任何 Windows 10/11 x64 系统上直接运行
- ⚠️ 文件体积较大（约 70-100 MB）

**适用场景：**
- 分发给最终用户
- 不确定目标系统是否安装 .NET 运行时
- 需要便携式独立运行的场景

**发布命令：**
```powershell
.\publish.ps1
# 或
.\publish.ps1 -Mode selfcontained
```

**输出位置：**
```
MoveWithSymlinkWPF\bin\publish\win-x64\目录迁移工具-v{版本号}.exe
```

---

### 2. 框架依赖版本 (Framework-Dependent / Lite)

**特点：**
- ✅ 体积非常小（约 2-5 MB）
- ✅ 仍然是单文件可执行程序
- ✅ 启动速度快
- ⚠️ 需要目标系统安装 .NET 8.0 Desktop Runtime

**适用场景：**
- 开发团队内部使用
- 目标系统已确认安装 .NET 8.0 运行时
- 需要快速分发和更新（体积小）
- 网络带宽受限的场景

**发布命令：**
```powershell
.\publish.ps1 -Mode lite
```

**输出位置：**
```
MoveWithSymlinkWPF\bin\publish\win-x64-framework-dependent\目录迁移工具-v{版本号}-lite.exe
```

**系统要求：**
目标系统需要安装 **.NET 8.0 Desktop Runtime (x64)**

下载地址：https://dotnet.microsoft.com/download/dotnet/8.0

选择：**.NET Desktop Runtime 8.0.x (x64)**

---

## 发布命令详解

### 基本用法

```powershell
# 1. 发布自包含版本（默认）
.\publish.ps1

# 2. 发布轻量级版本
.\publish.ps1 -Mode lite

# 3. 同时发布两个版本
.\publish.ps1 -Mode both

# 4. 不增加版本号（重新发布当前版本）
.\publish.ps1 -SkipVersionIncrement

# 5. 发布轻量级版本且不增加版本号
.\publish.ps1 -Mode lite -SkipVersionIncrement
```

### 独立发布脚本

如果只想发布框架依赖版本，也可以使用独立脚本：

```powershell
.\publish-framework-dependent.ps1
```

---

## 运行应用程序

### 使用启动脚本（推荐）

```powershell
.\run.ps1
```

启动脚本会自动：
1. 优先查找自包含版本
2. 如果没有，查找框架依赖版本（并检查运行时）
3. 如果都没有，使用 `dotnet run` 运行

### 直接运行 EXE

双击对应的 EXE 文件即可运行。

---

## 版本对比

| 特性 | 自包含版本 | 框架依赖版本 |
|------|-----------|-------------|
| 文件大小 | 70-100 MB | 2-5 MB |
| 运行时依赖 | 无 | 需要 .NET 8.0 Desktop Runtime |
| 启动速度 | 正常 | 较快 |
| 分发便利性 | 高（无依赖） | 中（需要运行时） |
| 适用场景 | 最终用户分发 | 内部使用/已有运行时 |
| 文件名后缀 | `-v{版本号}.exe` | `-v{版本号}-lite.exe` |

---

## 技术细节

### 自包含版本配置

**发布配置文件：** `win-x64.pubxml`

关键设置：
- `SelfContained=true` - 包含运行时
- `PublishSingleFile=true` - 单文件发布
- `EnableCompressionInSingleFile=true` - 启用压缩
- `IncludeNativeLibrariesForSelfExtract=true` - 包含本机库

### 框架依赖版本配置

**发布配置文件：** `win-x64-framework-dependent.pubxml`

关键设置：
- `SelfContained=false` - 不包含运行时
- `PublishSingleFile=true` - 单文件发布
- `RuntimeIdentifier=win-x64` - 目标平台

---

## 版本管理

版本号存储在 `version.json` 文件中：

```json
{
  "major": 1,
  "minor": 0,
  "patch": 5,
  "description": "目录迁移工具版本号"
}
```

每次运行 `publish.ps1` 时，默认会自动递增 `patch` 版本号。

使用 `-SkipVersionIncrement` 参数可以跳过版本号递增。

---

## 构建输出目录说明

### 开发构建输出

```
MoveWithSymlinkWPF/bin/Release/net8.0-windows10.0.19041.0/
├── 目录迁移工具.exe           # 启动器（框架依赖）
├── 目录迁移工具.dll           # 主程序 DLL
├── MigrationCore.dll         # 核心库 DLL
└── win-x64/                  # 完整的框架依赖输出（可删除）
    └── [200+ DLL 文件]       # 所有 .NET 运行时文件
```

**说明：**
- `win-x64/` 目录是 `dotnet build` 生成的中间产物
- 包含完整的 .NET 运行时和框架 DLL（约 200+ 个文件）
- 运行 `目录迁移工具.exe` 时不需要这个目录（使用系统运行时）
- 可以安全删除以节省空间

### 发布输出

#### 自包含版本
```
MoveWithSymlinkWPF/bin/publish/win-x64/
└── 目录迁移工具-v{版本号}.exe  # 单文件（70-100 MB）
```

#### 框架依赖版本
```
MoveWithSymlinkWPF/bin/publish/win-x64-framework-dependent/
└── 目录迁移工具-v{版本号}-lite.exe  # 单文件（2-5 MB）
```

---

## 最佳实践

### 开发阶段
- 使用 `dotnet run` 或 `.\run.ps1` 快速测试
- 不需要频繁发布

### 内部测试
- 使用框架依赖版本（`-Mode lite`）
- 体积小，分发快
- 确保测试机已安装 .NET 8.0 Desktop Runtime

### 正式发布
- 使用自包含版本
- 无依赖，用户体验最佳
- 发布前运行 `.\publish.ps1` 自动递增版本号

### 同时提供两个版本
```powershell
.\publish.ps1 -Mode both
```

用户可以根据自己的需求选择：
- 有运行时 → 下载轻量版
- 没运行时 → 下载完整版

---

## 常见问题

### Q: 为什么删除 win-x64 目录后程序还能运行？

A: 因为 `目录迁移工具.exe` 是框架依赖型启动器，它使用系统安装的 .NET 运行时，不需要 `win-x64` 目录中的文件。

### Q: 如何检查系统是否安装了 .NET 8.0 Desktop Runtime？

A: 运行以下命令：
```powershell
dotnet --list-runtimes | Select-String "Microsoft.WindowsDesktop.App 8\."
```

### Q: 轻量版在没有运行时的系统上会发生什么？

A: 会弹出错误提示，告知用户需要安装 .NET Desktop Runtime，并提供下载链接。

### Q: 可以只保留轻量版吗？

A: 可以，但需要确保所有用户的系统都安装了 .NET 8.0 Desktop Runtime。建议同时提供两个版本供用户选择。

---

## 更新日志

### v1.0.5+
- ✨ 新增框架依赖版本发布支持
- ✨ 新增 `publish.ps1` 的 `-Mode` 参数
- ✨ 优化 `run.ps1` 智能版本选择
- 📝 新增发布版本说明文档

