## 一键迁移模式 - 需求说明（v1.1）

更新时间：2025-10-28  作者：诏无言

### 背景
- 现有应用支持手动四步式迁移流程（验证→扫描→复制→建链→检查→清理）。
- 需求新增一种“极简的一键迁移模式”，用于按配置自动定位若干源目录并顺序执行迁移，面向特定应用的快捷使用场景。

### 目标
- 通过配置文件定义多个候选目录（来源于软件安装目录的相对路径或任意绝对路径）。
- 页面加载时自动扫描有效项；若无有效项，明确提示“无可一键迁移目录”。
- 支持统一目标目录或逐项单独目标目录策略，保留现有 6 阶段进度语义与日志输出。
- 顺序执行一键迁移任务，单项失败不阻塞后续项，最终提供结果汇总。

### 非目标（暂不实现）
- 不提供 GUI 配置编辑；配置通过外部 JSON 文件维护。
- 不提供“单键定位”按钮（注册表定位在一键模式内部隐式完成）。

### 术语
- Profile：表示一个软件实体，常通过注册表定位其安装根目录，再展开若干相对路径为待迁移源目录。
- Standalone Source：任意自定义的绝对源目录，独立于软件安装位置。

### 配置文件
- 文件名：`quick-migrate.json`（与可执行文件同目录）。
- 结构：

```json
{
  "defaults": {
    "largeFileThresholdMB": 1024,
    "robocopyThreads": 8,
    "targetStrategy": "unified",
    "unifiedTargetRoot": "E:\\Migrated"
  },
  "profiles": [
    {
      "id": "NovaStudio",
      "name": "NovaStudio",
      "locator": {
        "type": "registryDisplayIcon",
        "hive": "HKCU",
        "keyPath": "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\NovaStudio",
        "valueName": "DisplayIcon"
      },
      "items": [
        { "displayName": "项目", "relativePath": "Projects", "enabled": true },
        { "displayName": "模板", "relativePath": "Assets\\Templates", "enabled": false }
      ]
    },
    {
      "id": "LocalToolkit",
      "name": "本地工具集",
      "locator": {
        "type": "absolutePath",
        "path": "D:\\Tools\\LocalToolkit"
      },
      "items": [
        { "displayName": "缓存", "relativePath": "Cache", "enabled": true },
        { "displayName": "日志", "relativePath": "Logs", "enabled": true }
      ]
    }
  ],
  "standaloneSources": [
    { "displayName": "资源库A", "absolutePath": "D:\\Repo\\LibA", "enabled": true }
  ]
}
```

#### 解析规则
- `profiles[*].locator`：
  - `type: "registryDisplayIcon"`: 读取注册表值 `DisplayIcon`，位置由 `hive` + `keyPath` + `valueName` 指定，示例路径：
    - `HKCU\Software\Microsoft\Windows\CurrentVersion\Uninstall\NovaStudio` → 值名 `DisplayIcon`。
    - 取值清洗：去除包裹引号与末尾的`,数字`（如`,0`），对 `.exe` 取其所在目录作为“安装根目录”。
  - `type: "absolutePath"`: 直接使用 `path` 指定的绝对目录作为安装根目录；需保证路径存在且为绝对路径。
  - 展开 `items[*].relativePath` 至绝对“源目录”；存在即为有效任务，不存在跳过。
- `standaloneSources[*]`：`absolutePath` 存在即为有效任务，否则跳过。
- 去重：若多个项解析到相同物理路径，保留首个任务并去重其余。

### 页面与交互（WPF 新页面）
- 入口：主界面左侧或页头提供“⏩ 一键迁移”入口，点击跳转到一键迁移页面（与手动模式并存，互不影响）。
- 页面加载：自动读取并解析 `quick-migrate.json`，完成定位与有效性筛选。
- 空状态：若无任何有效任务，页面中央显示“无可一键迁移目录”，并提供“返回”和“刷新扫描”。

#### 列表呈现与分组
- 将同一 `profile` 的任务放入一个分组容器（GroupBox/Card），左上角显示软件名 `name`。
- `standaloneSources` 独立分组为“自定义目录”。
- 每个任务占一行：
  - 左：源目录（只读文本）。
  - 中：六阶段点位（1验证、2扫描、3复制、4创建链接、5健康检查、6清理备份）。复制阶段显示百分比文本或小型条。
  - 右：目标目录。根据目标策略只读/可编辑（见下）。

#### 目标目录策略（顶栏切换）
- 统一目标目录：勾选后仅显示“统一根目录”选择器，实际目标路径为 `统一根/源目录名`（保留现有自动拼接与非空目录保护逻辑）。
- 分任务目录：不勾选时，每行提供“选择目标”入口，逐项设置。

#### 操作区
- 刷新扫描：重新加载配置并重跑定位/有效性筛选。
- 开始一键迁移：按列表顺序依次执行；单项失败记录并继续下一项。
- 取消：取消当前执行中的任务，并停止后续执行。
- 返回：返回手动模式。

### 执行流程（顺序执行）
1) 读取配置并解析有效任务列表。
2) 用户确认目标策略与（如需）目标目录。
3) 逐项执行迁移，每项使用现有 `MigrationService`，阶段语义保持：
   - 1 路径解析与验证
   - 2 扫描源目录
   - 3 复制文件（按总进度映射 10%-90%，建议启用可续传模式）
   - 4 创建符号链接
   - 5 健康检查
   - 6 清理备份
4) 每项结束在行尾显示状态（完成/失败/跳过），并写入统一日志区域。
5) 所有项执行后展示结果汇总。

#### 建议的复制参数调整
- 为支持中断续传与低权限回退，建议在 `robocopy` 参数中增加：
  - `/Z`（Restartable mode，可续传大文件）
  - `/ZB`（当无法以普通模式读取时，回退到 Backup 模式）
  - 其余参数保持与当前实现一致（`/MIR /COPYALL /DCOPY:DAT /R:0 /W:0 /XJ /NFL /NDL /NP /MT:n`）。

### 错误处理与边界条件
- 注册表缺失/软件未安装：对应 `profile` 无有效任务（该分组不显示）。
- 源目录不存在：该项跳过，不纳入有效任务。
- 目标目录安全：沿用现有验证逻辑（非空目录自动拼接源目录名、磁盘空间校验、权限提示）。
- 复制阶段异常或退出码≥8：标记失败并继续后续任务；如发生回滚，则按现有逻辑执行并记录日志。

### 权限与兼容性
- 非管理员运行时提示“若未启用开发者模式，创建符号链接可能失败”。
- 同时兼容 x64/x86 注册表视图（通过 `locator` 的 `hive`/路径精确选择）。

### 日志与可观测性
- 页底统一日志区域，带时间戳，记录每项阶段与结果。
- 行内显示当前阶段与复制进度概览，详细信息在日志区域。

### 验收标准（Done）
- 无配置/无安装/目录均不存在时，页面显示“无可一键迁移目录”。
- 可加载 `quick-migrate.json` 并正确解析、清洗 `DisplayIcon` 定位安装根。
- 能展示按软件分组的多行任务，支持统一/分任务目标策略。
- 能顺序执行所有有效任务，阶段点位实时更新，日志完整。
- 单项失败不影响后续项，最终有简要汇总。

### 后续扩展（建议）
- `locator.type` 扩展为多种策略（如 StartMenu LNK、App Paths），以提升定位成功率。
- 任务并行执行（当前明确为顺序执行，不在本版本范围）。

---

## 迁移状态与还原（新增 v1.1 强化）

### 页面改造：已迁移 / 未迁移 Tabs
- 一键迁移页面顶部采用 Tab 切换：`未迁移`、`已迁移`。
- `未迁移`：展示所有“可迁移且尚未迁移”的任务（来源于配置扫描与定位结果）。
- `已迁移`：展示所有“已迁移”的任务（优先来自迁移日志的激活记录；若缺失日志但检测到符号链接也应纳入，并标记为“未登记”以提示信息不完整）。
- 状态变化实时反映：迁移完成后，该任务从`未迁移`移动到`已迁移`；还原完成后，从`已迁移`移回`未迁移`。

### 迁移状态判定
- 基于两类信息：
  1) 文件系统状态：`SourcePath` 是否为目录符号链接（重解析点），以及其链接目标。
  2) 迁移日志：不做要求，日志可被删除，一般通过目录符号链接就可以判断了。
- 判定规则：
  - `Migrated`：`SourcePath` 是符号链接，且日志中存在该任务的激活记录（目标一致）。
  - `Pending`：`SourcePath` 存在且不是符号链接（或不存在但可由定位推导出来的有效源）。
  - `Invalid`：定位失败/源不存在/权限不足等（不进入列表或仅在空状态下说明原因）。
- 跨会话识别迁移：
  - 目的：支持跨会话识别“已迁移”，为“还原”提供可信元数据；未来手动迁移沿用同一机制。
  - 仅通过目录类型是否为目录符号链接识别。不管是否本软件迁移。


### 还原（Restore）能力与复用设计
- 需求：`已迁移` 列表中的任务不可再次迁移，只能执行“还原”。还原逻辑需可复用（未来手动模式也使用）。

#### 服务层设计
- 扩展为通用服务：`MigrationService` 支持两种模式，或新增 `ReversibleMigrationService`：
  - `MigrationMode.Migrate`：现有正向流程（源→目标，创建符号链接）。
  - `MigrationMode.Restore`：反向流程（目标→源，移除符号链接）。
- 进度与阶段仍为 6 阶段，文案适配：
  1) 路径解析与验证（验证当前为符号链接且指向记录的目标）
  2) 扫描“当前数据源”（还原时扫描目标路径）
  3) 复制文件（还原时为 目标→源）
  4) 解除符号链接（还原时：删除源处符号链接）
  5) 健康检查（确认源可访问且数据量达标）
  6) 清理备份/收尾（可选清理目标数据）

#### 关键校验与操作要点
- 校验：
  - 源路径必须存在且为符号链接（还原前置条件）。
  - 源所在磁盘可用空间充足（复制回源时）。
- 复制：继续使用 `robocopy`，参数与正向一致，仅交换源/目标。
- 解链：删除源处符号链接（仅在复制完成且通过校验后）。
- 收尾：
  - 默认清理目标数据（释放空间）。
  - 提供可配置选项 `restore.keepTarget=false|true`（默认 false），保留或删除原目标数据。

### UI 与交互更新
- Tabs：
  - `未迁移`：与原设计一致，显示可迁移项，操作为“开始迁移”。
  - `已迁移`：
    - 行展示：源目录（符号链接）与目标目录（来自日志或实时解析）以及迁移时间；
    - 操作仅“还原”；
- 刷新：两侧列表均支持“刷新扫描”，从文件系统重建视图。

### 验收标准（新增）
- 页面包含 `未迁移/已迁移` 两个 Tab，并能在迁移/还原后实时移动任务归属。
- `已迁移` 列表中的任务不可再次迁移，只能执行“还原”；还原成功后任务回到 `未迁移`。


## 中断与恢复策略

### 中断场景
- 用户取消：在“复制”阶段中断当前项。
- 应用崩溃/断电/系统重启：可能发生在任意阶段。

### 文件系统状态判定（无日志依赖）
- 关键对象：
  - 源路径 `SourcePath`（可能为普通目录或目录符号链接）。
  - 目标路径 `TargetPath`（复制目标）。
  - 备份路径 `_backupPath`：形如 `源目录名.bak_yyyyMMdd_HHmmss`，位于源的父目录。

### 恢复/修复策略（自动识别 + 用户操作）
1) 复制未完成（常见于阶段3被中断）
   - 条件：`SourcePath` 为普通目录；`TargetPath` 存在但内容不完整。
   - 策略：显示为“可恢复”，操作为“继续迁移”（再次执行复制，使用 `/MIR /Z` 续传）。

2) 已移动源为备份，但未创建符号链接（阶段4中断）
   - 条件：`SourcePath` 不存在；同级目录存在一个或多个以 `源名.bak_` 开头的备份；`TargetPath` 存在。
   - 策略：显示为“待完成”，提供两种操作：
     - “继续完成”：在 `SourcePath` 位置创建符号链接指向 `TargetPath`（跳过复制）。
     - “立即还原”：将最近的备份目录移动回 `SourcePath`，并保持 `TargetPath` 不变（可选清理目标）。

3) 已创建符号链接，但未清理备份（阶段6中断）
   - 条件：`SourcePath` 为符号链接指向 `TargetPath`，同时存在 `*.bak_*` 备份。
   - 策略：显示为“待清理”，提供“清理备份”或“还原”。

4) 符号链接存在但目标缺失（不一致）
   - 条件：`SourcePath` 为符号链接，但 `TargetPath` 不存在或不可访问。
   - 策略：显示为“异常”，仅提供“还原”（若发现备份则从备份恢复；无备份则提示无法自动恢复，需用户手动处理）。

5) 目标存在完整数据，源为普通目录（重复执行/历史残留）
   - 条件：`SourcePath` 为普通目录；`TargetPath` 存在且数据完整（大小接近、文件数接近）。
   - 策略：仍按迁移流程执行：复制校验→备份→建链，保证一致性；或允许“跳过复制，直接建链”（高级选项）。

### 备份发现与选择规则
- 若存在多个 `*.bak_*`，默认选择“最新修改时间”的目录作为主要备份。
- 允许在“异常/待完成/待清理”状态下展开备份列表并手动选择目标备份（可选）。

### UI 对应
- 未迁移 Tab：
  - 正常项：按钮“开始迁移”。
  - 可恢复项（复制未完成）：按钮“继续迁移”。
  - 待完成项（缺链接）：按钮“继续完成”与“还原”。
- 已迁移 Tab：
  - 待清理项：提供“清理备份”与“还原”。
  - 异常项：仅“还原”（若可用）。

### 还原安全阈值
- 还原前校验：
  - `SourcePath` 当前为符号链接。
  - `TargetPath` 可访问且包含预期数据；
  - `SourcePath` 所在卷剩余空间 ≥ 目标数据量 × (1 + 安全系数10%)。
- 复制回源完成后：删除 `SourcePath` 符号链接，再移动/复制回原位；根据 `restore.keepTarget` 决定是否删除 `TargetPath`。

### 准入与幂等
- 每个操作应具备幂等性：重复执行不会导致额外副作用。
- 检测到“目标状态已满足”时，直接跳过该子步骤（例如符号链接已存在且指向目标）。

### 辅助标记（不强依赖）
#### 迁移
- 删除可能存在的 `.xinghe-reduction.lock`和`.xinghe-reduction.done`
- 为提升“复制中断识别”的准确性，可在 `TargetPath` 根创建隐藏标记：
  - `.xinghe-migrate.lock`：复制开始时创建，包含 `SourcePath`、启动时间；
  - `.xinghe-migrate.done`：复制完成后写入；
  - 崩溃后存在 `.xinghe-migrate.lock` 无 `.xinghe-migrate.done` 可判定为“复制未完成”。
- 即便标记缺失，仍以文件系统状态为主进行判定与恢复。

#### 还原
- 删除可能存在的`.xinghe-migrate.lock`和`.xinghe-migrate.done`
- 其余逻辑相同，文件名 用 `.xinghe-reduction.lock`和`.xinghe-reduction.done`


