# 还原模式UI和验证逻辑调整说明

## 调整概述

根据还原模式的特殊需求，调整了界面文本、按钮标签和验证逻辑，使其更符合还原操作的语义。

## 主要调整

### 1. 按钮文本动态化

#### 步骤1：路径选择页面
**按钮**：`开始扫描` / `开始验证`

- **迁移模式**：显示"开始扫描"
- **还原模式**：显示"开始验证"

**原因**：还原模式主要是验证符号链接和目标路径的有效性，而不是扫描源目录。

#### 步骤2：扫描分析页面
**标题**：`扫描分析` / `验证还原条件`
**按钮**：`开始迁移` / `开始还原`

- **迁移模式**：
  - 标题："扫描分析"
  - 说明："将扫描源目录并分析文件信息..."
  - 按钮："开始迁移"

- **还原模式**：
  - 标题："验证还原条件"
  - 说明："将扫描符号链接指向的数据目录并分析文件信息..."
  - 按钮："开始还原"

### 2. 验证逻辑分离

#### 迁移模式验证（原有逻辑）

```csharp
// 1. 验证源路径（普通目录）
// 2. 自动调整目标路径（如果需要）
// 3. 验证目标路径存在性
// 4. 检查目标目录是否为空
// 5. 验证路径关系（不能嵌套）
// 6. 检查磁盘空间
// 7. 权限检查
```

#### 还原模式验证（新增逻辑）

```csharp
// 1. 验证源路径必须是符号链接 ✅
// 2. 验证目标路径（符号链接指向）必须存在 ✅
// 3. 检查源磁盘空间（需要容纳还原的数据）✅
// 4. 权限检查 ✅
```

### 3. 还原模式特殊验证

#### 验证1：源路径必须是符号链接
```csharp
if (!SymbolicLinkHelper.IsSymbolicLink(SourcePath))
{
    throw new InvalidOperationException("源路径不是符号链接，无法执行还原操作");
}
```

**错误提示**：
```
❌ 源路径不是符号链接，无法执行还原操作
```

#### 验证2：目标路径必须存在
```csharp
if (!Directory.Exists(TargetPath))
{
    throw new InvalidOperationException($"符号链接指向的目标路径不存在：{TargetPath}");
}
```

**错误提示**：
```
❌ 符号链接指向的目标路径不存在：[路径]
```

#### 验证3：源磁盘空间检查
```csharp
// 检查源磁盘是否有足够空间容纳还原的数据
string? sourceDrive = Path.GetPathRoot(SourcePath);
var driveInfo = new DriveInfo(sourceDrive);
long estimatedSize = // 计算目标目录大小

if (driveInfo.AvailableFreeSpace < estimatedSize * 1.1) // 需要1.1倍空间
{
    ValidationMessage = "⚠️ 警告：源磁盘可用空间可能不足\n" +
                       $"可用: {FormatBytes(available)}\n" +
                       $"预计需要: {FormatBytes(required)}";
}
```

**警告提示**：
```
⚠️ 警告：源磁盘可用空间可能不足
可用: 50.0 GB
预计需要: 60.5 GB
```

#### 验证4：成功提示
```
✅ 还原模式验证通过
   将还原符号链接为真实目录
   源（符号链接）: C:\testMove\02
   数据来源: C:\Users\...\Downloads\test1\02

⚠️ 当前非管理员权限，若未启用开发者模式，还原操作可能失败
```

## UI变化对比

### 迁移模式 (蓝色)

| 步骤 | 标题 | 按钮文本 | 说明文本 |
|------|------|---------|---------|
| 步骤1 | 选择源目录和目标目录 | 开始扫描 | - |
| 步骤2 | 扫描分析 | 开始迁移 | 将扫描源目录并分析文件信息... |
| 步骤3 | 执行迁移 | - | - |
| 步骤4 | 迁移结果 | - | - |

### 还原模式 (橙色)

| 步骤 | 标题 | 按钮文本 | 说明文本 |
|------|------|---------|---------|
| 步骤1 | 选择源目录和目标目录 | 开始验证 | - |
| 步骤2 | 验证还原条件 | 开始还原 | 将扫描符号链接指向的数据目录... |
| 步骤3 | 执行还原 | - | - |
| 步骤4 | 还原结果 | - | - |

## 验证流程示例

### 成功的还原验证

**输入**：
- 源路径：`C:\testMove\02` (符号链接)
- 目标路径：`C:\Users\xinghe_zwy\Downloads\test1\02` (自动填充)

**验证过程**：
1. ✅ 检测到符号链接
2. ✅ 目标路径存在
3. ✅ 磁盘空间充足（80GB 可用，需要 55GB）
4. ⚠️ 非管理员权限警告

**验证消息**：
```
✅ 还原模式验证通过
   将还原符号链接为真实目录
   源（符号链接）: C:\testMove\02
   数据来源: C:\Users\xinghe_zwy\Downloads\test1\02

⚠️ 当前非管理员权限，若未启用开发者模式，还原操作可能失败
```

### 失败的还原验证

#### 情况1：源不是符号链接

**错误消息**：
```
❌ 源路径不是符号链接，无法执行还原操作
```

#### 情况2：目标路径不存在

**错误消息**：
```
❌ 符号链接指向的目标路径不存在：C:\NonExistent\Path
```

#### 情况3：磁盘空间不足

**警告消息**：
```
⚠️ 警告：源磁盘可用空间可能不足
可用: 10.5 GB
预计需要: 50.2 GB

✅ 还原模式验证通过
   将还原符号链接为真实目录
   ...
```

## 技术实现

### XAML动态文本绑定

```xml
<!-- 按钮文本根据模式切换 -->
<Button Command="{Binding StartScanFromStep1Command}">
    <Button.Style>
        <Style TargetType="Button">
            <Setter Property="Content" Value="开始扫描"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsRestoreMode}" Value="True">
                    <Setter Property="Content" Value="开始验证"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Button.Style>
</Button>
```

### C# 验证逻辑分支

```csharp
[RelayCommand]
private async Task StartScanFromStep1Async()
{
    try
    {
        await Task.Run(() =>
        {
            if (MigrationMode == MigrationMode.Restore)
            {
                // ========== 还原模式验证 ==========
                ValidateRestore();
            }
            else
            {
                // ========== 迁移模式验证 ==========
                ValidateMigration();
            }

            // 权限检查（两种模式都需要）
            CheckPermissions();
        });

        // 验证通过，进入步骤2
        CurrentStep = 2;
        await ScanAsync();
    }
    catch (Exception ex)
    {
        // 显示错误
        HasValidationError = true;
        ValidationMessage = ex.Message;
    }
}
```

## 用户体验改进

### 清晰的语义

- **迁移模式**：扫描 → 迁移
- **还原模式**：验证 → 还原

用户能够明确知道当前操作的性质。

### 准确的提示

- 还原模式不再提示"目标目录不为空"（不适用）
- 还原模式明确提示源必须是符号链接
- 还原模式检查源磁盘空间而不是目标磁盘

### 友好的错误信息

所有验证错误都有明确的中文提示，帮助用户理解问题所在。

## 测试建议

### 测试场景1：正常还原验证
1. 选择符号链接：`C:\testMove\02`
2. 点击"开始验证"
3. 验证：
   - ✅ 显示"开始验证"按钮
   - ✅ 验证通过
   - ✅ 进入步骤2，标题为"验证还原条件"
   - ✅ 按钮显示"开始还原"

### 测试场景2：源不是符号链接
1. 选择普通目录
2. 手动切换到还原模式（通过手动输入符号链接路径后再改回普通路径）
3. 点击"开始验证"
4. 验证：
   - ❌ 显示错误："源路径不是符号链接，无法执行还原操作"

### 测试场景3：目标路径不存在
1. 选择一个损坏的符号链接（指向不存在的路径）
2. 点击"开始验证"
3. 验证：
   - ❌ 显示错误："符号链接指向的目标路径不存在：[路径]"

### 测试场景4：磁盘空间不足
1. 选择指向大型目录的符号链接
2. 确保源磁盘空间不足
3. 点击"开始验证"
4. 验证：
   - ⚠️ 显示警告但允许继续

## 总结

通过分离迁移和还原模式的验证逻辑，并调整UI文本，大幅提升了还原功能的用户体验和语义准确性。

**改进要点**：
- ✅ 按钮文本准确反映操作类型
- ✅ 验证逻辑符合还原操作的实际需求
- ✅ 错误提示清晰明确
- ✅ 磁盘空间检查针对正确的磁盘
- ✅ 用户能清楚知道当前处于什么模式



