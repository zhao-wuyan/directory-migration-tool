# v1.1 一键迁移 - 快速上手指南

## 前置条件

1. Windows 10/11 操作系统
2. .NET 8.0 Runtime
3. 足够的磁盘空间（目标盘）
4. 管理员权限或已启用开发者模式（用于创建符号链接）

## 第一步：创建配置文件

在应用程序所在目录（与 .exe 文件同级）创建 `quick-migrate.json` 文件。

### 示例配置

```json
{
  "defaults": {
    "largeFileThresholdMB": 1024,
    "robocopyThreads": 8,
    "targetStrategy": "unified",
    "unifiedTargetRoot": "E:\\Migrated",
    "restoreKeepTarget": false
  },
  "profiles": [],
  "standaloneSources": [
    {
      "displayName": "我的文档",
      "absolutePath": "C:\\Users\\YourName\\Documents\\MyProject",
      "enabled": true
    }
  ]
}
```

### 配置说明

#### defaults 节
- **largeFileThresholdMB**: 大文件阈值（MB），默认 1024
- **robocopyThreads**: 复制线程数，默认 8
- **targetStrategy**: 目标策略
  - `"unified"`: 统一目标目录（所有任务迁移到同一根目录下）
  - `"perTask"`: 分任务目录（每个任务单独指定目标）
- **unifiedTargetRoot**: 统一目标根目录（targetStrategy 为 unified 时使用）
- **restoreKeepTarget**: 还原时是否保留目标数据（默认 false，会删除）

#### standaloneSources 节
最简单的方式，直接指定要迁移的绝对路径：

```json
{
  "displayName": "显示名称",
  "absolutePath": "完整路径",
  "enabled": true
}
```

#### profiles 节（高级）
用于自动定位软件安装根目录：

- `type: "registryDisplayIcon"`：通过注册表读取 `DisplayIcon` 路径。
- `type: "absolutePath"`：直接使用配置中的 `path` 作为安装根目录。

```json
{
  "id": "唯一标识",
  "name": "软件名称",
  "locator": {
    "type": "registryDisplayIcon",
    "hive": "HKCU",
    "keyPath": "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\AppName",
    "valueName": "DisplayIcon"
  },
  "items": [
    {
      "displayName": "项目目录",
      "relativePath": "Projects",
      "enabled": true
    }
  ]
}
```

> 例：若软件未在注册表中记录安装信息，可将 `type` 改为 `"absolutePath"` 并新增字段 `"path": "D:\\Tools\\MyApp"`，其余字段保持不变。

## 第二步：启动应用

1. 运行"目录迁移工具.exe"
2. 点击顶部的"⏩ 一键迁移"按钮

## 第三步：扫描任务

应用会自动加载配置并扫描有效任务：
- 检查 standaloneSources 中的路径是否存在
- 通过 profiles 定位软件安装目录并展开相对路径
- 检测每个任务的迁移状态

### 可能的情况

#### 情况 1：无可迁移目录
- 页面显示"无可一键迁移目录"
- 原因：配置文件不存在、路径全部无效、或软件未安装
- 解决：检查配置文件，确认路径存在

#### 情况 2：找到任务
- "未迁移" Tab 显示待迁移任务
- "已迁移" Tab 显示已迁移任务
- 顶部显示统计信息

## 第四步：选择目标目录

### 统一目标模式（推荐）

1. 确保"统一目标目录"已勾选
2. 在文本框中输入或点击"浏览..."选择目标根目录
3. 例如：`E:\Migrated`
4. 实际迁移时，每个任务会自动在根目录下创建子目录，如：
   - 源：`C:\Users\Me\Documents\MyProject`
   - 目标：`E:\Migrated\MyProject`

### 分任务目录模式

1. 取消勾选"统一目标目录"
2. 每个任务行会显示"选择目标"按钮
3. 逐个设置目标路径

## 第五步：开始迁移

1. 点击"开始一键迁移"按钮
2. 观察任务卡片上的进度条和状态
3. 底部日志区域实时显示详细信息
4. 迁移按列表顺序执行，单项失败不影响后续

### 迁移过程

每个任务经历 6 个阶段：
1. ✓ 路径解析与验证
2. ✓ 扫描源目录
3. ✓ 复制文件（占 80% 时间）
4. ✓ 创建符号链接
5. ✓ 健康检查
6. ✓ 清理备份

### 迁移完成

- 成功任务从"未迁移"移到"已迁移"
- 源目录变成符号链接（外观不变）
- 实际数据存储在目标位置

## 第六步：验证

### 在文件资源管理器中
- 打开源目录（符号链接），应能正常访问
- 图标可能显示快捷方式标记
- 功能与原目录完全一致

### 在应用中
- 切换到"已迁移" Tab
- 查看任务列表
- 确认迁移时间和路径

## 还原操作

如果需要恢复原始状态：

1. 切换到"已迁移" Tab
2. 找到要还原的任务
3. 点击"还原"按钮
4. 确认提示
5. 等待还原完成（也是 6 个阶段）

### 还原后
- 符号链接被删除
- 数据从目标复制回源
- 任务回到"未迁移" Tab
- 根据配置决定是否删除目标数据

## 清理备份

迁移完成后，可能存在备份目录（如 `MyProject.bak_20251028_123456`）：

1. 在"已迁移" Tab 中
2. 找到显示"已迁移，但存在备份待清理"的任务
3. 点击"清理备份"按钮
4. 确认删除
5. 备份目录被永久删除

**注意**: 清理备份后无法通过备份还原，请确保迁移无误！

## 常见问题

### Q1: 提示"当前非管理员权限"
**A**: 
- 以管理员身份运行应用，或
- 在 Windows 设置中启用"开发者模式"

### Q2: 复制速度慢
**A**: 
- 调整配置中的 `robocopyThreads`（默认 8）
- 考虑网络或磁盘性能

### Q3: 中断后如何继续
**A**: 
- 重新启动应用
- 应用会自动检测未完成任务
- 任务显示为"可恢复"状态
- 再次执行会从中断处继续

### Q4: 目标磁盘空间不足
**A**: 
- 应用会在扫描阶段检测并阻止迁移
- 清理目标磁盘或更换目标位置

### Q5: 符号链接创建失败
**A**: 
- 检查是否有管理员权限
- 检查是否启用开发者模式
- 查看日志了解详细错误

### Q6: 还原时选择"保留目标数据"
**A**: 
- 修改配置文件中的 `restoreKeepTarget` 为 `true`
- 重启应用
- 还原时会保留目标目录中的数据

### Q7: 如何添加更多任务
**A**: 
- 编辑 `quick-migrate.json`
- 在 `standaloneSources` 中添加新项
- 保存后点击"刷新扫描"

## 高级用法

### 通过注册表定位软件

如果你想迁移已安装软件的特定目录：

1. 找到软件在注册表中的卸载信息：
   - 路径：`HKCU\Software\Microsoft\Windows\CurrentVersion\Uninstall\软件名`
   - 或：`HKLM\Software\Microsoft\Windows\CurrentVersion\Uninstall\软件名`

2. 确认存在 `DisplayIcon` 值（通常是软件的 .exe 路径）

3. 在配置文件的 `profiles` 节添加：

```json
{
  "id": "MySoftware",
  "name": "我的软件",
  "locator": {
    "type": "registryDisplayIcon",
    "hive": "HKCU",
    "keyPath": "Software\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\MySoftware",
    "valueName": "DisplayIcon"
  },
  "items": [
    {
      "displayName": "项目目录",
      "relativePath": "Projects",
      "enabled": true
    },
    {
      "displayName": "缓存目录",
      "relativePath": "Cache",
      "enabled": false
    }
  ]
}
```

4. 刷新扫描，应用会自动定位软件安装目录并展开相对路径

### 批量迁移策略

对于多个大型目录：
- 使用统一目标模式
- 选择高速大容量目标盘（如 SSD 或独立数据盘）
- 适当增加 `robocopyThreads`（如 16）
- 在空闲时段执行（避免影响正常使用）

## 注意事项

1. **备份重要数据**: 虽然应用有回滚机制，但重要数据请先备份
2. **磁盘空间**: 确保目标盘有足够空间（源大小 + 10% 余量）
3. **不要手动修改**: 迁移过程中不要手动修改源/目标目录
4. **应用兼容性**: 部分应用可能不支持符号链接，请在迁移后测试
5. **权限问题**: 某些系统目录可能需要特殊权限
6. **不支持网络路径**: 源和目标必须是本地磁盘

## 示例场景

### 场景 1：迁移项目目录到大容量盘

```json
{
  "defaults": {
    "targetStrategy": "unified",
    "unifiedTargetRoot": "E:\\Projects"
  },
  "standaloneSources": [
    {
      "displayName": "VS项目",
      "absolutePath": "C:\\Users\\Me\\source\\repos",
      "enabled": true
    },
    {
      "displayName": "Unity项目",
      "absolutePath": "C:\\Unity\\Projects",
      "enabled": true
    }
  ]
}
```

### 场景 2：迁移多个软件的数据目录

```json
{
  "defaults": {
    "targetStrategy": "unified",
    "unifiedTargetRoot": "D:\\AppData"
  },
  "profiles": [
    {
      "id": "App1",
      "name": "应用1",
      "locator": { /* ... */ },
      "items": [
        { "displayName": "数据", "relativePath": "Data", "enabled": true }
      ]
    },
    {
      "id": "App2",
      "name": "应用2",
      "locator": { /* ... */ },
      "items": [
        { "displayName": "项目", "relativePath": "Projects", "enabled": true }
      ]
    }
  ]
}
```

## 总结

v1.1 的一键迁移模式让批量目录迁移变得简单：
1. 配置一次，多次使用
2. 自动检测状态
3. 一键执行批量迁移
4. 完整的还原支持
5. 中断后可恢复

开始使用吧！🚀


