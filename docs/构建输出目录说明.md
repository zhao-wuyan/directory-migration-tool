# 构建输出目录说明

## 目录结构概览

```
MoveWithSymlinkWPF/bin/
├── Release/
│   └── net8.0-windows10.0.19041.0/
│       ├── 目录迁移工具.exe           # 框架依赖启动器
│       ├── 目录迁移工具.dll           # 应用程序主 DLL
│       ├── MigrationCore.dll         # 核心库
│       ├── CommunityToolkit.Mvvm.dll # 依赖库
│       ├── *.deps.json               # 依赖配置
│       ├── *.runtimeconfig.json      # 运行时配置
│       └── win-x64/                  # ⚠️ 中间产物目录
│           └── [200+ 个 DLL 文件]    # .NET 运行时和框架文件
│
└── publish/
    ├── win-x64/                      # 自包含版本输出
    │   └── 目录迁移工具-v*.exe       # 单文件 EXE (70-100 MB)
    │
    └── win-x64-framework-dependent/  # 框架依赖版本输出
        └── 目录迁移工具-v*-lite.exe  # 单文件 EXE (2-5 MB)
```

## 各目录详解

### 1. `Release/net8.0-windows10.0.19041.0/` (开发构建输出)

**用途：** `dotnet build` 或 `dotnet run` 的输出目录

**包含：**
- `目录迁移工具.exe` - **框架依赖型启动器**
  - 大小约 150 KB
  - 依赖系统安装的 .NET 8.0 运行时
  - 加载同目录下的 DLL 文件
  
- `目录迁移工具.dll` - 应用程序主程序集
- `MigrationCore.dll` - 核心功能库
- 其他依赖 DLL 和配置文件

**运行方式：**
```powershell
.\MoveWithSymlinkWPF\bin\Release\net8.0-windows10.0.19041.0\目录迁移工具.exe
```

需要系统安装 .NET 8.0 Desktop Runtime。

---

### 2. `Release/.../win-x64/` (⚠️ 可删除的中间产物)

**用途：** `dotnet build` 生成的带运行时的完整输出（中间产物）

**包含：**
- 所有 .NET 8.0 运行时 DLL（约 200+ 个文件）
- CoreCLR、JIT 编译器、WPF 框架等完整文件
- 应用程序 DLL 和依赖

**特点：**
- ❌ **不是最终产物**，是构建过程的中间文件
- ❌ 体积巨大（未压缩，约 200+ MB）
- ❌ 文件分散（200+ 个独立文件）
- ✅ **可以安全删除**
- ✅ 重新构建会自动重新生成

**为什么可以删除？**

运行 `目录迁移工具.exe`（父目录中的启动器）时：
1. 启动器查找系统安装的 .NET 8.0 运行时
2. 使用系统运行时加载应用程序 DLL
3. **不会使用** `win-x64` 目录中的文件

只有当你执行以下操作时才会使用此目录：
```powershell
.\MoveWithSymlinkWPF\bin\Release\net8.0-windows10.0.19041.0\win-x64\目录迁移工具.exe
```

但这样运行没有实际意义，因为：
- 文件未压缩，体积大
- 需要完整目录结构
- 不如直接运行父目录的启动器

---

### 3. `publish/win-x64/` (自包含版本)

**用途：** 生产环境分发的自包含单文件版本

**生成命令：**
```powershell
.\publish.ps1
# 或
.\publish.ps1 -Mode selfcontained
```

**包含：**
- `目录迁移工具-v{版本号}.exe` - 单个 EXE 文件

**特点：**
- ✅ 包含完整的 .NET 8.0 运行时（自包含）
- ✅ 单文件可执行程序
- ✅ 启用压缩（约 70-100 MB）
- ✅ 无需目标系统安装任何依赖
- ✅ 可在任何 Windows 10/11 x64 系统运行
- ✅ 真正的便携式应用程序

**推荐场景：**
- 分发给最终用户
- 不确定目标系统运行时环境
- 需要便携式独立运行

**发布配置：** `win-x64.pubxml`
```xml
<SelfContained>true</SelfContained>
<PublishSingleFile>true</PublishSingleFile>
<EnableCompressionInSingleFile>true</EnableCompressionInSingleFile>
```

---

### 4. `publish/win-x64-framework-dependent/` (框架依赖版本)

**用途：** 轻量级的框架依赖单文件版本

**生成命令：**
```powershell
.\publish.ps1 -Mode lite
```

**包含：**
- `目录迁移工具-v{版本号}-lite.exe` - 单个 EXE 文件

**特点：**
- ✅ 体积小巧（约 2-5 MB）
- ✅ 单文件可执行程序
- ✅ 启用压缩
- ✅ 启动速度快
- ⚠️ 需要目标系统安装 .NET 8.0 Desktop Runtime

**推荐场景：**
- 开发团队内部使用
- 目标系统已确认有运行时
- 快速迭代和分发
- 网络带宽受限

**系统要求：**
目标系统需要安装 **.NET 8.0 Desktop Runtime (x64)**

下载：https://dotnet.microsoft.com/download/dotnet/8.0

**发布配置：** `win-x64-framework-dependent.pubxml`
```xml
<SelfContained>false</SelfContained>
<PublishSingleFile>true</PublishSingleFile>
<EnableCompressionInSingleFile>true</EnableCompressionInSingleFile>
```

---

## 体积对比

| 类型 | 位置 | 大小 | 文件数 |
|------|------|------|--------|
| 开发构建 | `Release/.../` | ~10 MB | ~10 个 |
| **中间产物** | `Release/.../win-x64/` | **~200 MB** | **200+ 个** |
| 自包含发布 | `publish/win-x64/` | ~70-100 MB | 1 个 |
| 框架依赖发布 | `publish/win-x64-framework-dependent/` | ~2-5 MB | 1 个 |

---

## 清理建议

### 安全可删除
```powershell
# 删除中间产物（可随时重新生成）
Remove-Item -Recurse -Force "MoveWithSymlinkWPF\bin\Release\net8.0-windows10.0.19041.0\win-x64"

# 删除所有 bin/obj 目录（清理构建）
dotnet clean
```

### 保留文件
- `bin/Release/net8.0-windows10.0.19041.0/*.exe` - 开发用启动器
- `bin/Release/net8.0-windows10.0.19041.0/*.dll` - 开发用程序集
- `bin/publish/` - 发布的最终产物

---

## 常见问题

### Q: 为什么删除 `win-x64` 目录后程序还能运行？

A: 因为 `目录迁移工具.exe`（父目录中的）是框架依赖型启动器，它使用系统安装的 .NET 运行时，不依赖 `win-x64` 目录。

### Q: `win-x64` 目录什么时候有用？

A: 几乎从不需要。这是 `dotnet build` 生成的中间产物。如果你想要自包含的可执行文件，应该使用 `dotnet publish` 并启用单文件发布。

### Q: 如何只保留最终产物？

A: 发布后，只需保留 `bin/publish/` 目录中的文件，其他都可以删除：

```powershell
# 保留发布文件到临时位置
Move-Item "MoveWithSymlinkWPF\bin\publish" ".\publish-backup"

# 清理构建
dotnet clean

# 恢复发布文件
Move-Item ".\publish-backup" "MoveWithSymlinkWPF\bin\publish"
```

### Q: 开发时应该使用哪个 EXE？

A: 开发时推荐使用：
1. `.\run.ps1` - 自动选择最佳版本（推荐）
2. `dotnet run` - 直接运行项目
3. `bin/Release/.../目录迁移工具.exe` - 开发构建版本

不推荐使用 `bin/Release/.../win-x64/目录迁移工具.exe`。

---

## 工作流建议

### 开发阶段
```powershell
# 快速运行测试
.\run.ps1
# 或
cd MoveWithSymlinkWPF
dotnet run -c Release
```

### 内部测试
```powershell
# 发布轻量版
.\publish.ps1 -Mode lite -SkipVersionIncrement

# 分发给测试人员
# 确保他们安装了 .NET 8.0 Desktop Runtime
```

### 正式发布
```powershell
# 发布两个版本
.\publish.ps1 -Mode both

# 提供两个版本供用户选择
# - 完整版：无需安装运行时
# - 轻量版：需要运行时，体积小
```

---

## 总结

- **开发构建** (`bin/Release`) → 本地开发和测试
- **中间产物** (`bin/Release/.../win-x64`) → ⚠️ 可删除，无实际用途
- **自包含发布** (`bin/publish/win-x64`) → 最终用户分发
- **框架依赖发布** (`bin/publish/win-x64-framework-dependent`) → 内部使用/快速分发

**最佳实践：**
1. 开发时使用 `.\run.ps1` 或 `dotnet run`
2. 内部测试使用框架依赖版本
3. 正式发布同时提供两个版本
4. 定期清理 `win-x64` 中间产物节省空间

